# 智能客服小聚2.0升级方案

## 项目背景
智能客服小聚主要提供信息咨询服务，而文章管理是通过直接编辑Markdown文件和使用Astro的Content API实现的。目前两者之间没有直接的集成，内容管理人员需要通过复杂的流程来创建和更新文章。

## 升级目标
实现通过智能客服小聚新建和更新文章的功能，提升内容管理的效率和便捷性，使内容创作者能够通过自然语言交互快速发布和更新内容。

## 技术方案

### 1. 开发文章管理API
- **目标**：创建用于新建、更新和删除文章的API端点
- **实施细节**：
  - 利用Astro的API路由功能实现服务端逻辑
  - 实现对Markdown文件的CRUD操作
  - 集成身份验证和权限控制
  - 利用现有的WordPress集成功能(wordpress.js)扩展文章管理能力
- **变更文件**：
  - `src/pages/api/articles/[slug].ts` (新建) - 处理文章CRUD操作
  - `src/lib/auth.ts` (修改) - 扩展权限控制
  - `src/lib/wordpress.js` (修改) - 扩展文章管理能力
  - `src/content/config.ts` (修改) - 添加文章管理相关配置

### 2. 扩展智能客服知识库
- **目标**：添加与文章管理相关的意图和回复模板
- **实施细节**：
  - 在ChatWidget.astro中添加新意图定义（create_article、update_article等）
  - 设计文章管理相关的回复模板和交互流程
  - 优化关键词识别算法，支持部分匹配和同义词匹配
  - 优化上下文感知意图识别，支持多轮对话收集文章信息
- **变更文件**：
  - `src/components/ChatWidget.astro` (修改) - 添加意图和回复模板

### 3. 集成智能客服与文章管理API
- **目标**：实现对话与API的交互逻辑
- **实施细节**：
  - 在ChatWidget.astro中添加API调用逻辑（saveArticleToAPI、updateArticleToAPI函数）
  - 实现文章信息收集流程，支持分段输入和"完成"指令
  - 设计确认和反馈机制，确保操作准确性
  - 实现异步操作处理和错误重试机制
- **变更文件**：
  - `src/components/ChatWidget.astro` (修改) - 添加API调用和交互逻辑
  - `src/lib/articleService.ts` (新建) - 封装文章服务

### 4. 添加安全机制
- **目标**：确保系统安全性和可审计性
- **实施细节**：
  - 实现基于JWT的身份验证中间件
  - 添加操作日志记录系统，包含日志级别和采样机制
  - 实现错误处理机制和异常情况应对策略
  - 优化会话状态管理和超时机制
- **变更文件**：
  - `src/middleware.ts` (修改) - 添加身份验证中间件
  - `src/lib/logger.ts` (新建) - 实现日志系统
  - `src/lib/errorHandler.ts` (新建) - 错误处理机制

## 实施步骤与更改节奏点

### 阶段一：API开发与集成准备（1-2天）
1. **更改点**：创建文章管理API端点
   - 新建`src/pages/api/articles/[slug].ts`处理文章CRUD操作
   - 利用现有`src/lib/wordpress.js`中的API交互模式
2. **问题**：跨域访问控制
   - **解决**：在API端点添加CORS头部，确保前端能正常访问
3. **更改点**：扩展内容配置
   - 更新`src/content/config.ts`，添加文章管理相关配置

### 阶段二：知识库扩展（1天）
1. **更改点**：添加文章管理意图
   - 在`ChatWidget.astro`中添加`create_article`、`update_article`等意图
   - 定义相关回复模板和快速回复选项
2. **问题**：意图冲突与识别准确性
   - **解决**：优化关键词匹配算法，增加上下文感知能力
3. **更改点**：设计文章创建和更新流程
   - 实现多轮对话收集文章信息的逻辑
   - 添加文章字段验证

### 阶段三：智能客服与API集成（2天）
1. **更改点**：实现文章操作函数
   - 在`ChatWidget.astro`中添加`saveArticleToAPI`和`updateArticleToAPI`函数
   - 模拟API调用，添加错误处理和重试机制
2. **问题**：异步操作处理
   - **解决**：使用Promise和async/await处理API调用，添加加载状态指示
3. **更改点**：完善用户交互
   - 添加文章创建/更新成功的反馈信息
   - 实现对话上下文重置机制

### 阶段四：安全机制与测试（1-2天）
1. **更改点**：添加身份验证
   - 实现基于JWT的身份验证机制
   - 添加权限检查，确保只有授权用户可以修改文章
2. **问题**：会话状态管理
   - **解决**：优化localStorage存储，添加会话超时机制
3. **更改点**：添加操作日志
   - 记录所有文章创建和更新操作
   - 实现日志查询接口

## 示例交互流程

1. 用户："小聚，帮我新建一篇文章"
2. 小聚："您好！请问这篇文章的标题是什么？"
3. 用户："2025年下半年投资策略分析"
4. 小聚："好的，文章标题已记录。请问文章属于哪个专栏？（可选择：日斗专栏、聚财策略、聚财播客）"
5. 用户："聚财策略"
6. 小聚："已选择聚财策略专栏。请您提供文章内容，我会帮您创建文章。"
7. 用户："（提供文章内容）"
8. 用户："完成"
9. 小聚："文章已创建成功！标题为《2025年下半年投资策略分析》，属于聚财策略专栏。请问您需要进一步编辑吗？"

## 关键问题与解决方案

### 1. 意图识别准确性问题
**问题**：用户输入的自然语言可能模糊或包含多种意图
**解决方案**：
- 增强上下文感知能力，根据对话历史判断用户意图
- 增加意图置信度评分，对于低置信度的意图进行二次确认
- 优化关键词匹配算法，支持部分匹配和同义词匹配

### 2. 文章内容输入问题
**问题**：用户可能需要输入长文本内容，单轮对话难以完成
**解决方案**：
- 实现多轮对话收集文章内容，支持分段输入
- 添加"完成"指令，指示用户输入结束
- 提供内容预览功能，确保文章内容符合预期

### 3. API调用错误处理
**问题**：网络不稳定或API故障可能导致文章操作失败
**解决方案**：
- 实现API调用重试机制，对于临时性错误自动重试
- 添加错误日志记录，便于问题排查
- 提供友好的错误提示，指导用户采取正确的操作

## 后续维护建议
1. 定期备份文章数据，防止数据丢失
2. 监控API调用日志，及时发现异常情况
3. 根据用户反馈持续优化意图识别和对话流程
4. 定期更新和维护依赖库，确保系统安全
5. 维护关键词库，不断提升意图识别准确性
6. 考虑添加文章版本控制功能，便于回滚和追踪变更

## 版本记录
| 版本 | 日期       | 变更说明                 | 变更人 |
|------|------------|--------------------------|--------| 
| v2.0.0 | 2025-XX-XX | 初始版本，实现基本的文章创建和更新功能 | 开发团队 |
| v2.0.1 | 2025-XX-XX | 修复意图识别准确性问题，优化用户交互体验 | 开发团队 |
| v2.1.0 | 2025-XX-XX | 添加文章分类选择功能，扩展知识库 | 开发团队 |