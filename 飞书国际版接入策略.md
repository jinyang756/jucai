# 飞书国际版自建应用接入策略

## 一、项目背景与目标

当前网站已完成分栏结构优化，拥有日斗专栏、聚财策略、聚财播客和音乐专栏四个分栏。为提高内容更新效率，拟接入飞书国际版自建应用，实现便捷的网页端内容录入与分栏更新，同时确保网站正常运转。

## 二、当前网站内容结构分析

### 1. 分栏配置
```typescript
// src/config/columns.ts
[
  { id: 'insights', name: '日斗专栏', description: '每日市场洞察与分析', icon: '📊', route: '/insights' },
  { id: 'strategies', name: '聚财策略', description: '投资策略与理财建议', icon: '💹', route: '/strategies' },
  { id: 'podcasts', name: '聚财播客', description: '音频形式的深度分析', icon: '🎧', route: '/podcasts' },
  { id: 'music', name: '音乐专栏', description: '背景音乐与阅读氛围', icon: '🎵', route: '/music-player' }
]
```

### 2. 内容模型
```typescript
// src/content/config.ts
const posts = defineCollection({
  type: 'content',
  schema: z.object({
    title: z.string(),
    description: z.string(),
    publishDate: z.string(),
    coverImage: z.string().optional(),
    type: z.enum(['article', 'podcast']), // 内容类型
    column: z.enum(['日斗专栏', '聚财策略', '聚财播客']), // 分栏归属
    audioUrl: z.string().optional(), // 仅播客需要
    duration: z.string().optional(), // 仅播客需要
  }),
});
```

## 三、飞书国际版接入方案

### 1. 飞书应用创建与配置

#### 步骤1：创建企业自建应用
1. 登录飞书国际版开发者平台
2. 创建企业自建应用，填写基本信息
3. 添加机器人能力和必要的权限（文档读写、消息发送等）
4. 获取App ID和App Secret用于后续认证

#### 步骤2：配置权限
需要的核心权限：
- 文档内容读写权限
- 多维表格数据读写权限
- 消息推送权限
- 用户信息获取权限

### 2. 内容同步机制设计

#### 方案概述
采用飞书多维表格作为中间媒介，实现内容的录入与同步：
1. 在飞书创建多维表格，定义与网站内容模型对应的字段
2. 开发同步脚本，定期从飞书多维表格获取最新内容
3. 将获取的内容转换为网站支持的格式并更新到对应分栏

#### 多维表格设计
| 字段名       | 类型     | 说明                     |
|------------|----------|--------------------------|
| title      | 文本     | 文章/播客标题            |
| description| 文本     | 内容描述                 |
| publishDate| 日期     | 发布日期                 |
| coverImage | 附件     | 封面图片                 |
| type       | 单选     | 内容类型（article/podcast）|
| column     | 单选     | 分栏归属                 |
| audioUrl   | 文本     | 播客音频链接（可选）     |
| duration   | 文本     | 播客时长（可选）         |
| content    | 富文本   | 文章正文                 |
| status     | 单选     | 状态（草稿/已发布）      |
| syncStatus | 文本     | 同步状态（未同步/已同步）|

### 3. 网页应用端设计

创建一个HTML页面，集成飞书SDK，提供以下功能：
1. 飞书账号登录与授权
2. 分栏选择器
3. 内容编辑器（支持富文本）
4. 媒体文件上传（图片、音频）
5. 发布预览与确认
6. 内容发布历史记录

```html
<!-- 飞书国际版内容更新网页应用示例结构 -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>聚财众发 - 内容管理系统</title>
  <!-- 引入飞书SDK -->
  <script src="https://sf1-cdn-tos.bytegoofy.com/obj/ttfe/fe-sso/2.1.2/index.js"></script>
  <!-- 引入Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- 引入富文本编辑器 -->
  <script src="https://cdn.ckeditor.com/ckeditor5/41.2.1/classic/ckeditor.js"></script>
</head>
<body class="bg-gray-50 min-h-screen">
  <!-- 页面内容 -->
</body>
</html>
```

### 4. 同步脚本实现

创建一个Node.js脚本，定期执行同步任务：

```javascript
// sync-feishu-content.js
const fs = require('fs');
const path = require('path');
const { Feishu } = require('feishu-sdk');

// 飞书配置
const feishu = new Feishu({
  appId: 'YOUR_APP_ID',
  appSecret: 'YOUR_APP_SECRET',
  // 其他配置
});

async function syncContent() {
  try {
    // 1. 从飞书多维表格获取待同步内容
    const records = await feishu.base.getRecords({
      appToken: 'YOUR_BASE_APP_TOKEN',
      tableId: 'YOUR_TABLE_ID',
      filter: 'syncStatus = "未同步"',
    });

    // 2. 处理每条记录
    for (const record of records) {
      // 转换为网站内容格式
      const content = transformToWebsiteFormat(record);

      // 3. 写入网站内容目录
      writeToContentFolder(content);

      // 4. 更新同步状态
      await feishu.base.updateRecord({
        appToken: 'YOUR_BASE_APP_TOKEN',
        tableId: 'YOUR_TABLE_ID',
        recordId: record.record_id,
        fields: { syncStatus: '已同步' },
      });
    }

    console.log('内容同步完成');
  } catch (error) {
    console.error('内容同步失败:', error);
  }
}

syncContent();
```

## 四、实施步骤与注意事项

### 实施步骤
1. 创建飞书自建应用并配置权限
2. 设计并创建飞书多维表格
3. 开发网页应用端
4. 开发同步脚本
5. 测试与调试
6. 正式部署与上线

### 注意事项
1. **数据安全**：确保飞书应用权限最小化，保护用户数据和内容安全
2. **错误处理**：同步过程中添加完善的错误处理机制，避免数据丢失
3. **版本控制**：对同步的内容进行版本控制，便于回滚
4. **性能优化**：针对大量内容同步，优化脚本性能，避免超时
5. **监控告警**：设置同步失败告警机制，及时发现问题
6. **合规性**：确保内容符合相关法律法规，避免违规内容发布

## 五、技术选型建议
1. **前端框架**：Vue.js或React，提供更好的用户体验
2. **富文本编辑器**：CKEditor或TinyMCE，支持复杂内容编辑
3. **任务调度**：使用node-cron或pm2定时执行同步脚本
4. **云服务**：考虑使用云函数（如阿里云函数计算）运行同步任务，降低维护成本
5. **安全认证**：使用JWT进行网页应用端的身份认证

## 六、后续优化方向
1. 实现实时同步，减少延迟
2. 添加内容审核流程
3. 开发移动端适配版本
4. 集成AI辅助写作功能
5. 提供内容数据分析和统计功能